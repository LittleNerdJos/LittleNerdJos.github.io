<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

	<title>Fish Taggers</title>
	
	<style type="text/css" id="sns_global_styles">td {vertical-align:top;}
		.above-local-nav-sidebar .widget-container{margin:0;}
		a.logo-link{display:inline-block;}
		.above-local-nav-sidebar{margin-bottom:-10px;}
		blockquote{clear:none;}
		.lesson-thumb{text-align:center;}
		.cta{float:none;}
		#sample div, #lake div, #tagged div, #fish_in_lake div {
			display: inline-block;
			width: 80px;
			height: 80px;
			margin:10px;
		}
		.whitefish.tagged {
			background-image:url('https://i.ibb.co/qn5hH6g/whitefish-tag.jpg');
		}
		.whitefish{
			background-image:url('https://i.ibb.co/D9PHfGY/whitefish.jpg');
		}
		.trout.tagged {
			background-image:url('https://i.ibb.co/7g6NqRM/trout-tag.jpg');
		}
		.trout{
			background-image:url('https://i.ibb.co/HNs81Nb/trout.jpg');
		}
		.bass.tagged {
			background-image:url('https://i.ibb.co/bB8f3ty/bass-tag.jpg');
		}
		.bass{
			background-image:url('https://i.ibb.co/Xt3Yn1V/bass.jpg');
		}
		</style>

  </head>
  <body>
    <h1>Fish Taggers</h1>
				<div class="row">
					<div class="col">
						<p class="lead">This app simulates the &ldquo;sample-tag-resample&rdquo; method for estimating the <a
								href="https://docs.google.com/document/d/1eB0ZplPz-rchd9W0ZKCdzYqB6fuX9J8v6W4lQ3GJKdY/edit?usp=sharing" target="_blank" rel="noopener">population of fish in
								a lake</a>.
							The simulator creates a random number of fish of 3 types, depending on your choice of lake (if random, a new
							lake is generated). </p>
					</div>
				</div>
<div id="sim-settings" class="row">
	<div class="col card card-body bg-light">
		<div class="model-choice pick-lake-type">
			<h4>Choose a Lake</h4>
			<div class="form-group">
				<input type="radio" name="pick_lake_type" value="random" id="random" checked class="form-control">
				<label for="random">
					Random</label><br>
				<input type="radio" name="pick_lake_type" value="CDA" id="CDA" class="form-control">
				<label for="CDA">
					Lake Coeur d&rsquo;Alene</label><br>
				<input type="radio" name="pick_lake_type" value="Payette" id="Payette" class="form-control">
				<label for="Payette"> Payette Lake</label><br>
				<input type="radio" name="pick_lake_type" value="Anderson" id="Anderson" class="form-control">
				<label for="Anderson"> Anderson Ranch Reservoir</label>
				<div>
		</div>
		<div class="model-choice pick-sampsize">
			<h4>Number of Fish to Sample &amp; Tag</h4>
			<div class="form-group">
				<!-- <label class="dropdown" for="pick_sampsize"> --><select id="pick_sampsize" title="Number of Fish" class="form-control">
					<option value="10">10</option>
					<option value="20">20</option>
					<option value="30">30</option>
					<option value="40">40</option>
					<option value="50">50</option>
					<option value="60">60</option>
					<option value="70">70</option>
					<option selected value="80">80</option>
					<option value="90">90</option>
					<option value="100">100</option>
					<option value="200">200</option>
					<option value="300">300</option>
					<option value="400">400</option>
					<option value="500">500</option>
				</select><br><!-- </label> -->
			</div>
		</div>
		<div class="model-choice pick-sampsize">
			<h4>Number of Fish to Resample after Tagging</h4>
			<div class="form-group">
				<!-- <label class="dropdown" for="pick_resample"> --><select id="pick_resample"
					title="Number of Fish to Resample" class="form-control">
					<option value="10">10</option>
					<option value="20">20</option>
					<option value="30">30</option>
					<option selected value="40">40</option>
					<option value="50">50</option>
					<option value="100">100</option>
				</select><br><!-- </label> -->
			</div>
		</div>
	</div>

</div>

<div id="accordion">
		<div class="card">
		  <div class="card-header" id="headingOne">
			<h5 class="mb-0">
			  <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
					Step 1. Tag a Random Sample of Fish
			  </button>
			</h5>
		  </div>
	  
		  <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordion">
			<div class="card-body">
					<a id="run-sample" class="btn btn-lg btn-primary" href="#">Sample and Tag Fish</a>
					<div id="tagged"></div>			
				</div>
		  </div>
		</div>
		<div class="card">
		  <div class="card-header" id="headingTwo">
			<h5 class="mb-0">
			  <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
					Step 2. Resample Fish (after tagging)
			  </button>
			</h5>
		  </div>
		  <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion">
			<div class="card-body">
					<a id="run-resample" class="btn btn-lg btn-primary" style="display: none;" href="#">Resample Fish</a>  
					<div id="sample"></div>
			</div>
		  </div>
		</div>
		<div class="card">
		  <div class="card-header" id="headingThree">
			<h5 class="mb-0">
			  <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
					All Fish in Lake
			  </button>
			</h5>
		  </div>
		  <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordion">
			<div class="card-body">
					<div id="lake"></div>			
				</div>
		  </div>
		</div>
	  </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
	<script type="text/javascript">
		(function($) {
			$(document).ready(function () {
				
			$( window ).resize(function() {
				//adjust size of images based on width of objects
			  return false;
			});
			/*
			*		LOGIC:
			*			1. Choose fish in lake.
			*			2. Make a lake (of random size with chosen fish).
			*			3. Tag a sample of fish in the lake (by clicking on a fixed number of fish).
			* 			4. Keep track of total number of tagged fish of each type.
			*			5. Get a sample of fish (tagged and non-tagged).
			*			6. Sort sample of fish at user request.
			*
			*/
			// 1. 
				
			// SET-UP PARAMETERS FOR THE MODEL
				var fish = ['trout','whitefish','bass']; // get from .fishes checkboxes	
				
				var lake_pop = make_lake(501,1000, "random");
				var lake_tagged =[];
				var lake_not_tagged = [];
				var lake_sampled = [];
				
				var initial_tag = false;
				
				$('#run-sample').click(function(event){
					event.preventDefault();
					simulate_tagging();
					initial_tag = true;
					$('#run-resample').show();
					return false;
				});
				$('input[name=pick_lake_type]').click(function(event){
					var lake_type = $('input[name=pick_lake_type]:checked').val();
					lake_pop = make_lake(501, 1000, lake_type);
				});
				$('#run-resample').click(function(event){
					event.preventDefault();
					if(initial_tag){
						simulate_resampling();
					}
					return false;
				});
		
				insert_by_class(lake_pop, "lake");
				
				function simulate_tagging(){
					var sampsize = document.getElementById("pick_sampsize");
					 var sampsize_n = sampsize.options[sampsize.selectedIndex].value;
					lake_pop = sample_and_tag_lake(sampsize_n);
					insert_by_class(lake_tagged, "tagged");
					insert_by_class(lake_pop, "lake");
				}
				
				function simulate_resampling(){
					var resample = document.getElementById("pick_resample");
					 var resample_n = resample.options[resample.selectedIndex].value;
					// console.log(resample_n);
					lake_sampled = sample_lake( resample_n);
					insert_by_class(lake_sampled, "sample");
				}	
				
				function sample_and_tag_lake( n_tag ){
					lake_pop = shuffle(lake_pop);
					lake_tagged = lake_pop.slice(0, n_tag); // or n-1?
					lake_tagged = lake_tagged.map(function(x) { return x + " tagged"; });
					lake_non_tagged = lake_pop.slice(n_tag, lake_pop.length-1);
					return shuffle(lake_tagged.concat(lake_non_tagged));
				}
				
				function sample_lake (n_samp){
					lake_pop = shuffle(lake_pop);
					return( lake_pop.slice(0, n_samp) ); // or n-1?
				}
				
				
				// make a long array of fish using proportions from a lake
				function make_lake( min_n, max_n, lake_type){
					console.log("### Lake Type = "+lake_type);
					var inipop=[];
					var lake_N;
					var fish_props =[];
					
					if(lake_type == "random"){
						console.log("!New Random Lake!!")
						//random sized lake
						lake_N = min_n + Math.floor((max_n-min_n)*Math.random());
						
						//random proportions of fish in the lake
						for (j=0; j< fish.length; j++){
							var propsum = fish_props.reduce(function (a, b) { return a + b; }, 0); // sum the array
						
							if(j==fish.length-1){
								fish_props.push(1 - propsum);
							}
							else{
								fish_props.push( Math.max( (1-propsum)/(fish.length-j+1)*Math.random(),(1-propsum)/(2*fish.length) ));
							}
						}
					}
					else {
						if (lake_type=="CDA"){
							lake_N =1575;
							fish_props = [.525,.3,.175];
						}
						if (lake_type=="Payette"){
							lake_N = 2022;
							fish_props = [.385,.285,1-(.385+.285)]
						}
						if(lake_type =="Anderson"){
							lake_N = 2060;
							fish_props = [.26,.33,.41]
						}
						
					}
					
					
					//console.info(fish_props);
					for (j=0; j< fish.length; j++){
						var temp_n = Math.round(lake_N*fish_props[j]);
						//console.log(temp_n);
						var new_pop = Array.apply(null, Array(temp_n)).map(function (x, i) { 
												return fish[j]; 
											});
						//console.info(new_pop);
						inipop = inipop.concat(new_pop);
						console.log( 'Number of '+fish[j]+' = '+temp_n );
						
					
					}
					lake_N = inipop.length;
					console.log( 'Total lake population = '+lake_N );
					return shuffle(inipop);
				}
				
				// convert an array of class names to a bunch of html DOM elements
				function insert_by_class (class_array, targetid){
					var target = document.getElementById(targetid);
					target.innerHTML = "";
					for (var c in class_array) {
						var newElement = document.createElement('div');
						newElement.className = class_array[c];
						target.appendChild(newElement);
					}
				}
				// randomize an array
				function shuffle(array) {
					  var currentIndex = array.length, temporaryValue, randomIndex;
					
					  // While there remain elements to shuffle...
					  while (0 !== currentIndex) {
					
						// Pick a remaining element...
						randomIndex = Math.floor(Math.random() * currentIndex);
						currentIndex -= 1;
					
						// And swap it with the current element.
						temporaryValue = array[currentIndex];
						array[currentIndex] = array[randomIndex];
						array[randomIndex] = temporaryValue;
					  }
					
					  return array;
				}
				
			}); // end document.ready
		})(jQuery);
		</script>
		 
</body>
</html>